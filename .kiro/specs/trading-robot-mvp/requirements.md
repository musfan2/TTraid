# Требования: Торговый робот MVP ("Кормилец")

## Введение

Торговый робот для автоматизированной работы с T-Invest API (Тинькофф Инвестиции). Приложение на Delphi 12 (FMX) позволяет пользователю настраивать торговые заявки (ордера) на покупку/продажу активов, автоматически отслеживать текущие цены и исполнять торговую логику по расписанию. MVP-версия работает на Windows с использованием существующих Core-модулей проекта (TMyHttpClient, TTimerThread, TMySaveIniFile и др.).

## Глоссарий

- **Робот** — основное приложение TTraid ("Кормилец"), торговый робот
- **API_Клиент** — модуль для взаимодействия с T-Invest REST API через TMyHttpClient
- **Менеджер_Настроек** — модуль хранения и загрузки настроек приложения через TMySaveIniFile
- **Менеджер_Ордеров** — модуль управления списком торговых ордеров пользователя
- **Планировщик** — фоновый поток (TTimerThread) для периодического опроса API и исполнения торговой логики
- **Таблица_Ордеров** — визуальный компонент (TGrid/TStringGrid) для отображения списка ордеров
- **Ордер** — торговая заявка пользователя с параметрами инструмента, направления, количества, цены и логики исполнения
- **Quotation** — формат цены T-Invest API: объект с полями `units` (целая часть) и `nano` (дробная, 9 знаков)
- **Инструмент** — биржевой актив, идентифицируемый по FIGI или instrument_uid

## Требования

### Требование 1: Настройки подключения

**User Story:** Как пользователь, я хочу настроить параметры подключения к API (токен, прокси), чтобы робот мог взаимодействовать с T-Invest API.

#### Критерии приёмки

1. THE Менеджер_Настроек SHALL предоставить интерфейс для ввода и сохранения API-токена инвестиций, адреса прокси-сервера, порта прокси-сервера, логина прокси-сервера и пароля прокси-сервера
2. WHEN пользователь сохраняет настройки, THE Менеджер_Настроек SHALL записать параметры в INI-файл с использованием TMySaveIniFile
3. WHEN приложение запускается, THE Менеджер_Настроек SHALL загрузить ранее сохранённые настройки из INI-файла
4. WHEN пользователь вводит API-токен, THE Робот SHALL отображать токен в замаскированном виде (звёздочки) с возможностью временного показа
5. WHEN настройки подключения изменены, THE API_Клиент SHALL применить новые параметры прокси и токена без перезапуска приложения

### Требование 2: Проверка подключения к API

**User Story:** Как пользователь, я хочу проверить корректность настроек подключения, чтобы убедиться, что робот может работать с API.

#### Критерии приёмки

1. WHEN пользователь нажимает кнопку "Проверить подключение", THE API_Клиент SHALL выполнить запрос GetAccounts к T-Invest API
2. WHEN API возвращает список счетов, THE Робот SHALL отобразить список доступных счетов (ID, тип, название, статус)
3. IF API возвращает ошибку аутентификации (код 40003), THEN THE Робот SHALL отобразить сообщение "Токен недействителен или отсутствует"
4. IF соединение с API не установлено в течение 10 секунд, THEN THE Робот SHALL отобразить сообщение "Нет связи с сервером" и предложить проверить настройки прокси
5. WHEN список счетов получен, THE Менеджер_Настроек SHALL позволить пользователю выбрать активный счёт для торговли

### Требование 3: Управление списком ордеров

**User Story:** Как пользователь, я хочу видеть таблицу своих торговых ордеров и управлять ими, чтобы контролировать торговую активность робота.

#### Критерии приёмки

1. THE Таблица_Ордеров SHALL отображать список ордеров с колонками: статус, инструмент (тикер/FIGI), направление (покупка/продажа), количество лотов, целевая цена, текущая цена, тип ордера (лимитный/рыночный)
2. WHEN пользователь нажимает кнопку "Добавить ордер", THE Робот SHALL открыть форму создания нового ордера
3. WHEN пользователь выполняет двойной клик по строке ордера в таблице, THE Робот SHALL открыть форму редактирования выбранного ордера
4. WHEN пользователь нажимает кнопку "Удалить" для ордера, THE Робот SHALL запросить подтверждение и удалить ордер из списка
5. THE Менеджер_Ордеров SHALL сохранять список ордеров в INI-файл при каждом изменении
6. WHEN приложение запускается, THE Менеджер_Ордеров SHALL загрузить ранее сохранённые ордера из INI-файла

### Требование 4: Форма настройки ордера

**User Story:** Как пользователь, я хочу настраивать параметры каждого ордера, чтобы задать логику покупки или продажи актива.

#### Критерии приёмки

1. THE Робот SHALL предоставить форму с полями: инструмент (FIGI или тикер), направление (покупка/продажа), количество лотов, тип ордера (рыночный, лимитный, по лучшей цене), целевая цена (для лимитных ордеров)
2. WHEN пользователь выбирает тип ордера "рыночный", THE Робот SHALL скрыть поле целевой цены
3. WHEN пользователь выбирает тип ордера "лимитный", THE Робот SHALL отобразить поле целевой цены и сделать его обязательным
4. IF пользователь вводит количество лотов меньше 1, THEN THE Робот SHALL отобразить ошибку валидации и запретить сохранение
5. IF пользователь оставляет поле инструмента пустым, THEN THE Робот SHALL отобразить ошибку валидации и запретить сохранение
6. WHEN пользователь нажимает "Сохранить", THE Менеджер_Ордеров SHALL сохранить параметры ордера и обновить Таблицу_Ордеров

### Требование 5: Периодический опрос цен

**User Story:** Как пользователь, я хочу, чтобы робот автоматически получал текущие цены активов, чтобы видеть актуальную рыночную информацию.

#### Критерии приёмки

1. WHILE робот активен, THE Планировщик SHALL выполнять запрос GetLastPrices к API с интервалом, заданным пользователем (от 30 до 120 секунд)
2. WHEN получены новые цены, THE Таблица_Ордеров SHALL обновить колонку "текущая цена" для соответствующих инструментов
3. IF запрос цен завершился ошибкой, THEN THE Робот SHALL записать ошибку в лог и повторить запрос в следующем цикле без остановки работы
4. THE Менеджер_Настроек SHALL позволить пользователю задать интервал опроса цен в секундах
5. WHEN пользователь изменяет интервал опроса, THE Планировщик SHALL применить новый интервал без перезапуска робота

### Требование 6: Выставление торговых заявок

**User Story:** Как пользователь, я хочу, чтобы робот выставлял заявки на бирже, чтобы автоматизировать торговые операции.

#### Критерии приёмки

1. WHEN пользователь активирует ордер, THE API_Клиент SHALL отправить запрос PostOrder к T-Invest API с параметрами ордера
2. THE API_Клиент SHALL генерировать уникальный idempotency-ключ (orderId) для каждой заявки в формате GUID
3. WHEN API возвращает статус EXECUTION_REPORT_STATUS_FILL, THE Менеджер_Ордеров SHALL обновить статус ордера на "Исполнен"
4. WHEN API возвращает статус EXECUTION_REPORT_STATUS_NEW, THE Менеджер_Ордеров SHALL обновить статус ордера на "Ожидает исполнения"
5. IF API возвращает статус EXECUTION_REPORT_STATUS_REJECTED, THEN THE Менеджер_Ордеров SHALL обновить статус ордера на "Отклонён" и записать причину в лог
6. THE API_Клиент SHALL корректно формировать цену в формате Quotation (units + nano) из десятичного числа

### Требование 7: Отмена торговых заявок

**User Story:** Как пользователь, я хочу отменять ранее выставленные заявки, чтобы управлять своими позициями.

#### Критерии приёмки

1. WHEN пользователь нажимает "Отменить" для активного ордера, THE API_Клиент SHALL отправить запрос CancelOrder к T-Invest API
2. WHEN API подтверждает отмену, THE Менеджер_Ордеров SHALL обновить статус ордера на "Отменён"
3. IF API возвращает ошибку при отмене, THEN THE Робот SHALL отобразить сообщение об ошибке и сохранить текущий статус ордера

### Требование 8: Синхронизация с биржей

**User Story:** Как пользователь, я хочу видеть актуальный статус своих заявок на бирже, чтобы знать реальное состояние торговых операций.

#### Критерии приёмки

1. WHILE робот активен, THE Планировщик SHALL периодически запрашивать список активных заявок через GetOrders
2. WHEN получен список активных заявок с биржи, THE Менеджер_Ордеров SHALL синхронизировать статусы локальных ордеров с биржевыми
3. IF локальный ордер имеет статус "Ожидает исполнения", а биржевая заявка отсутствует в списке активных, THEN THE Менеджер_Ордеров SHALL обновить статус ордера на "Исполнен или отменён на бирже"

### Требование 9: Конвертация цен (Quotation)

**User Story:** Как разработчик, я хочу корректно конвертировать цены между десятичным форматом и форматом Quotation API, чтобы избежать ошибок в торговых операциях.

#### Критерии приёмки

1. THE API_Клиент SHALL конвертировать десятичное число в формат Quotation (units: целая часть, nano: дробная часть × 10⁹)
2. THE API_Клиент SHALL конвертировать формат Quotation обратно в десятичное число
3. FOR ALL допустимых десятичных значений цены, конвертация в Quotation и обратно SHALL возвращать эквивалентное значение (свойство round-trip)
4. WHEN дробная часть цены содержит более 9 знаков, THE API_Клиент SHALL округлить значение nano до 9 знаков

### Требование 10: Логирование операций

**User Story:** Как пользователь, я хочу видеть журнал операций робота, чтобы отслеживать его действия и диагностировать проблемы.

#### Критерии приёмки

1. WHEN робот выполняет API-запрос, THE Робот SHALL записать в лог: время, тип запроса, инструмент, результат (успех/ошибка)
2. WHEN происходит ошибка API, THE Робот SHALL записать в лог: время, код ошибки, текст ошибки, тело запроса
3. THE Робот SHALL отображать последние записи лога в интерфейсе (панель лога)
4. THE Робот SHALL ограничить размер лога в интерфейсе до 500 последних записей

### Требование 11: Запуск и остановка робота

**User Story:** Как пользователь, я хочу запускать и останавливать торгового робота, чтобы контролировать его работу.

#### Критерии приёмки

1. WHEN пользователь нажимает "Старт", THE Планировщик SHALL запустить периодический опрос цен и синхронизацию заявок
2. WHEN пользователь нажимает "Стоп", THE Планировщик SHALL остановить все периодические задачи
3. WHILE робот остановлен, THE Планировщик SHALL прекратить выполнение API-запросов
4. THE Робот SHALL отображать текущее состояние (запущен/остановлен) в интерфейсе
5. WHEN приложение закрывается, THE Робот SHALL корректно остановить Планировщик и сохранить все настройки

### Требование 12: Сериализация ордеров в INI-файл

**User Story:** Как разработчик, я хочу надёжно сохранять и загружать ордера из INI-файла, чтобы данные не терялись между сессиями.

#### Критерии приёмки

1. THE Менеджер_Ордеров SHALL сериализовать каждый ордер в отдельную секцию INI-файла с полями: InstrumentId, Direction, Quantity, OrderType, TargetPrice, Status
2. THE Менеджер_Ордеров SHALL десериализовать ордера из INI-файла обратно в объекты
3. FOR ALL допустимых ордеров, сериализация в INI и обратная десериализация SHALL возвращать эквивалентный объект ордера (свойство round-trip)
